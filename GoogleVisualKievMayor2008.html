<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map_canvas { height: 100% }
        #panel {
            position: absolute;
            top: 5px;
            left: 50%;
            margin-left: -180px;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
        }
    </style>
    <script type="text/javascript"
            src="js/vendor/jquery-1.9.1.min.js">
    </script>
    <script type="text/javascript"
            src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAB1alQoDJvJ9L5iIojuebZUhkBZeBN9OI&sensor=false">
    </script>

    <script type="text/javascript">
        //var url = 'http://localhost/InteractiveMaps/js/addresses_merged_phones_geo.json';
        //var url_regions = 'http://localhost/InteractiveMaps/js/districts_wiki.json';
        //var url_data = 'http://localhost/InteractiveMaps/js/mer2008_data.json';
        var url_regions = 'http://survey-archive.com/InteractiveMaps/js/districts_wiki.json';
        var url_data = 'http://survey-archive.com/InteractiveMaps/js/mer2008_data.json';
        var infoWindow;
        var map;
        var districts = [];
        var districts_by_candidate = {"ЧЕРНОВЕЦКИЙ": {title:"За Черновецкого",data:[]},
            "КЛИЧКО": {title:"За Кличко",data:[]},
            "ТУРЧИНОВ": {title:"За Турчинова",data:[]}
        };

        //var url = 'http://survey-archive.com/InteractiveMaps/js/polygons_backup219140.json';
        //var cache_url = 'http://localhost/InteractiveMaps/php/geocache.php';
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(50.468869,30.526886),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"),
                    mapOptions);

            $.getJSON(url_regions, function(data) {
                $.each(data, function(elem,val) {
                    var title = val["title"]
                    var bounds = val["bounds"]
                    var poly_coords = []
                    $.each(bounds, function(el,vl) {
                       var point = new google.maps.LatLng(vl["lat"],vl["lng"]);
                       poly_coords.push(point);
                    });
                    var voteUnit = new google.maps.Polygon({
                        paths: poly_coords,
                        strokeColor: '#000000',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        title: title
                    });

                    //voteUnit.setMap(map);

                    districts.push(voteUnit);
                });
                loadData();
             });



            infoWindow = new google.maps.InfoWindow();
        }
        function loadData(){
            $.getJSON(url_data, function(data) {
                var ratings = {"ЧЕРНОВЕЦКИЙ": [0,0],
                    "КЛИЧКО": [0,0],
                    "ТУРЧИНОВ": [0,0]
                };
                //alert("here");
                //alert(JSON.stringify(ratings));
                $.each(data, function(elem,val) {
                    $.each(ratings,function(el,v){
                        var rate = getCandidateRate(el,val["data"]);
                        if(v[0]==0) v[0] = rate;
                        if(v[1]==0) v[1] = rate;
                        if(rate < v[0]) v[0] = rate;
                        if(rate > v[1]) v[1] = rate;
                    });
                });
                //alert(JSON.stringify(ratings));
                $.each(data, function(elem,val) {
                    $.each(districts_by_candidate,function(el,v){
                        //alert(el);
                        var unit = selectDistrict(elem);
                        var voteUnit = new google.maps.Polygon({
                            paths: unit.getPath(),
                            strokeColor: '#000000',
                            strokeOpacity: 0.8,
                            strokeWeight: 3,
                            fillColor: '#FF0000',
                            fillOpacity: 0.35,
                            title: unit.title
                        });
                        var rate = getCandidateRate(el,val["data"]);
                        //alert(JSON.stringify(v.data));
                        voteUnit.fillOpacity = 0.40;
                        voteUnit.fillColor = setColorWithAcc(rate,ratings[el][1],ratings[el][0]);
                        voteUnit.rate = rate;
                        voteUnit.rate_text = v.title;
                        google.maps.event.addListener(voteUnit, 'click', showArrays);
                        v.data.push(voteUnit);
                        //alert("here");
                        //unit.setMap(map);
                    });

                });
                //alert(JSON.stringify(districts_by_candidate));
                chooseMap("ЧЕРНОВЕЦКИЙ");
            });
        }
        function getCandidateRate(name,votedata){
            var rate = 0;
            $.each(votedata, function(el,value) {
                if(value.candidate.indexOf(name)!=-1){
                    rate = value.v_perc;
                }
            });
            return rate;
        }
        function setColor(p){
            var red = p<50 ? 255 : Math.round(256 - (p-50)*5.12);
            var green = p>50 ? 255 : Math.round((p)*5.12);
            return "rgb(" + red + "," + green + ",0)";
        }
        function setColorWithAcc(p,max,min){
            var shred = (Number(max)+Number(min))/2;
            //alert(shred);
            var red = p<shred ? 255 : Math.round(256 - (p-shred)*(512/shred*2));
            var green = p>shred ? 255 : Math.round(256 - p*(512/shred*2));
            return "rgb(" + red + "," + green + ",0)";
        }
        function selectDistrict(name){
            var district = null;
            $.each(districts, function(el,value) {
                var title = value.title;
                if(title.indexOf(name)!=-1){
                    district = districts[el];
                }
            });
            return district;
        }
        function showArrays(event) {

            // Since this Polygon only has one path, we can call getPath()
            // to return the MVCArray of LatLngs
            var vertices = this.getPath();

            var contentString = '<b>'+this.title+'</b><br>';
            contentString += this.rate_text +" "+ this.rate+'%<br>';

            // Iterate over the vertices.
           /* for (var i =0; i < vertices.getLength(); i++) {
                var xy = vertices.getAt(i);
                contentString += '<br>' + 'Координаты: ' + i + '<br>' + xy.lat() +',' + xy.lng();
            }*/

            // Replace our Info Window's content and position
            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);

            infoWindow.open(map);
        }

     function chooseMap(candidate){
         //alert(districts_by_candidate.КЛИЧКО.data[0].toString());
         //alert(candidate);
         $.each(districts_by_candidate,function(elem,val){
             for(var i = 0; i < val.data.length;i++)
             {
                 if(elem == candidate) {
                     //alert("MATCH!");
                     //alert(val.data[i].rate_text);
                     val.data[i].setMap(map);
                 }else
                     val.data[i].setMap(null);
                 //alert(elem);

             }
             /*$.each(val.data,function(el,v){
                 alert(v);

             });*/
         });
     }

    </script>
</head>
<body onload="initialize()">
<div id="panel">
    <button onclick="chooseMap('ЧЕРНОВЕЦКИЙ')">Черновецкий</button>
    <button onclick="chooseMap('КЛИЧКО')">Кличко</button>
    <button onclick="chooseMap('ТУРЧИНОВ')">Турчинов</button>
</div>
<div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>